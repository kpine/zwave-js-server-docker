#!/bin/sh
set -e

if [ ! -c "${USB_PATH}" ]; then
  echo "USB path \"${USB_PATH}\" does not exist or is not a valid serial device"
  exit 1
fi

# Configure serial port:
#  - baud rate to 115200
#  - 8 bits
#  - 1 stop bit
#  - no parity
#  - no XON/XOFF flow control
#  - no RTS/CTS handshaking
stty -F "${USB_PATH}" 115200 cs8 -cstopb -parenb -ixon -crtscts

echo "Soft-resetting the controller..."
printf '\x01\x03\x00\x08\xf4' >"${USB_PATH}"
sleep 10

echo "Activating the booloader..."
printf '\x01\x03\x00\x27\xDB' >"${USB_PATH}"
sleep 1
# trigger bootloader menu
printf '\r' >"${USB_PATH}"

picocom --quiet --noinit --noreset --send-cmd="lsx -vv" --receive-cmd="" "${USB_PATH}"
